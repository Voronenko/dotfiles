#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# Define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

displayUsage() {
    echo "
An extension for pyenv virtualenv to instantiate a virtual environment and
associate the local folder with the same virtual environment

Usage:
  pyenv-here [-i] [-p python_version] <name>

Options:
  -i                    Interactive mode: use fzf to select missing args.
  -p <python_version>   Specify Python version explicitly.
  -l                    List available Python versions.
  -h                    Show this help.
"
}

INTERACTIVE=0
PYVER=""

# Parse options
while getopts ":hilp:" opt; do
    case ${opt} in
        i)
            INTERACTIVE=1
            ;;
        l)
            echo "Available virtual python versions:"
            pyenv versions
            exit 0
            ;;
        p)
            PYVER=${OPTARG}
            ;;
        h)
            displayUsage
            exit 0
            ;;
        \?)
            echo -e "${RED}Invalid option: -$OPTARG${NC}" >&2
            displayUsage
            exit 2
            ;;
        :)
            echo -e "${RED}Option -$OPTARG requires an argument.${NC}" >&2
            exit 2
            ;;
    esac
done
shift $((OPTIND - 1))

# Default python version is set only if not in interactive mode
if [[ $INTERACTIVE -eq 0 && -z "${PYVER:-}" ]]; then
    PYVER="$(pyenv versions --bare | grep -E '^[0-9]+(\.[0-9]+)*$' | head -1 || true)"
fi

# --- INTERACTIVE MODE ---
if [[ $INTERACTIVE -eq 1 ]]; then
    if ! command -v fzf >/dev/null 2>&1; then
        echo -e "${RED}fzf is required for interactive mode but not found.${NC}" >&2
        exit 1
    fi

    DEFAULT_PYVER="$(pyenv versions --bare | grep -E '^[0-9]+(\.[0-9]+)*$' | head -1 || echo system)"
    echo -e "${YELLOW}Interactive mode active. Default Python: ${DEFAULT_PYVER}${NC}"

    if [[ -z "${PYVER:-}" ]]; then
        PYLIST=$( (echo "system"; pyenv versions --bare | grep -E '^[0-9]+(\.[0-9]+)*$') )

        export FZF_DEFAULT_OPTS="
            --ansi
            --height=80
            --border
            --header='Select Python version (default: ${DEFAULT_PYVER})'
            --reverse
            --query='${DEFAULT_PYVER}'
            --preview-window=hidden
        "

        PYVER=$(echo "${PYLIST}" | fzf --prompt="Python> " || true)

        if [[ -z "${PYVER}" ]]; then
            PYVER="${DEFAULT_PYVER}"
            echo -e "${YELLOW}No version selected — using default ${PYVER}${NC}"
        fi
    fi

    if [[ $# -lt 1 ]]; then
        echo
        echo -e "${YELLOW}Enter a new virtualenv name based on ${PYVER} (type + Enter):${NC}"
        read -r -p "Virtualenv name> " ENVNAME
    else
        ENVNAME="$1"
    fi
else
    # --- NON-INTERACTIVE MODE ---
    if [[ $# -lt 1 ]]; then
        echo -e "${RED}Not enough arguments provided.${NC}"
        displayUsage
        exit 2
    fi
    ENVNAME="$1"
fi

# Sanity checks
if [[ -z "${PYVER:-}" ]]; then
    echo -e "${RED}Python version not set.${NC}" >&2
    exit 1
fi
if [[ -z "${ENVNAME:-}" ]]; then
    echo -e "${RED}Environment name not provided.${NC}" >&2
    exit 1
fi

# Init and associate pyenv virtualenv
echo -e "${GREEN}Creating virtualenv '${ENVNAME}' with Python ${PYVER}${NC}"
pyenv virtualenv "$PYVER" "$ENVNAME"
pyenv local "$ENVNAME"

# Upgrade pip within virtualenv
pyenv exec python -m pip install --upgrade pip

echo -e "${YELLOW}> Tip: it’s a good idea to have Poetry installed globally with pipx.${NC}"
read -p "$(echo -e "${YELLOW}Install local Poetry within project? [y/N]${NC} ")" ans
if [[ "$ans" =~ ^[yY]$ ]]; then
    pyenv exec python -m pip install poetry
    pyenv rehash
    pyenv exec poetry config virtualenvs.create false --local
    echo "command to install dependencies: pyenv exec poetry install --no-root"
else
    echo -e "${GREEN}Skipping installing Poetry.${NC}"
    if command -v poetry &>/dev/null; then
	echo "command to instruct poetry not to clatch with pyenv poetry config virtualenvs.create false --local"
        echo "command to install dependencies: poetry install --no-root"
    fi
fi

echo -e "${YELLOW}uv is an alternative package manager${NC}"
read -p "$(echo -e "${YELLOW}Install uv? [y/N]${NC} ")" ans
if [[ "$ans" =~ ^[yY]$ ]]; then
    pyenv exec python -m pip install uv
    pyenv rehash
    echo "command to install dependencies: pyenv exec uv sync"
else
    echo -e "${GREEN}Skipping installing uv.${NC}"
    if command -v uv &>/dev/null; then
        echo "command to install dependencies: pyenv exec uv sync"
    fi
fi
