#!/bin/bash
#
# pass-ssh-add: Load SSH private key stored in pass(1)

set -eu

# Function to list SSH keys in password store
list_ssh_keys() {
  find "${HOME}/.password-store/ssh" -name "*.gpg" -printf "%P\n" | sed 's/\.gpg$//' | sort
}

# Check if 'pass' is available
if ! command -v pass >/dev/null 2>&1; then
  echo "Error: 'pass' utility not found. Please install it first." >&2
  exit 1
fi

# Check if 'ssh-add' is available
if ! command -v ssh-add >/dev/null 2>&1; then
  echo "Error: 'ssh-add' command not found. Please install OpenSSH." >&2
  exit 1
fi

# Check if 'fzf' is available (needed for interactive selection)
if ! command -v fzf >/dev/null 2>&1; then
  echo "Warning: 'fzf' not found. Interactive selection will not be available." >&2
fi

# Handle parameter or interactive selection
if [ $# -eq 0 ]; then
  if ! command -v fzf >/dev/null 2>&1; then
    echo "Error: No key path provided and fzf not available for interactive selection." >&2
    echo "Usage: $0 <pass-entry-path>" >&2
    exit 1
  fi

  KEY_PATH="$(list_ssh_keys | fzf --prompt='Select SSH key: ' --height=40% --reverse || true)"

  if [ -z "${KEY_PATH}" ]; then
    echo "No key selected. Exiting."
    exit 0
  fi
else
  KEY_PATH="$1"
fi

# Create a temporary file to hold the private key
mkdir -p "/tmp/ssh/$(dirname "$KEY_PATH")"
TMP_KEY="$(mktemp "/tmp/ssh/$KEY_PATH.XXXXXX")"
trap 'rm -f "$TMP_KEY"' EXIT

# Retrieve and write the key securely
if ! pass show "ssh/$KEY_PATH" > "$TMP_KEY"; then
  echo "Error: Failed to retrieve key from pass: ssh/$KEY_PATH" >&2
  exit 1
fi

chmod 600 "$TMP_KEY"

# Add the key to ssh-agent
if ssh-add "$TMP_KEY"; then
  echo "✓ SSH key from pass '$KEY_PATH' successfully added."
else
  echo "✗ Failed to add SSH key from pass '$KEY_PATH'." >&2
  exit 1
fi
