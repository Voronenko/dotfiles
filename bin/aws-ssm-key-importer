#!/bin/bash

instance_id="$1"
username="$2"

select_instance_id() {
    aws ec2 describe-instances \
        --query "Reservations[*].Instances[*].[InstanceId, Tags[?Key=='Name'].Value|[0]]" \
        --output text |
        awk '{print $1, ($2 != "" ? $2 : "Unnamed")}' |
        fzf --prompt="Select instance ID: " |
        awk '{print $1}'
}

select_username() {
    local default="ubuntu"
    local choices=("ubuntu" "ec2-user" "custom/manual")

    selected=$(printf "%s\n" "${choices[@]}" | fzf --prompt="Select username (default: $default): ")

    if [[ -z "$selected" ]]; then
        echo "$default"
    elif [[ "$selected" == "custom/manual" ]]; then
        read -rp "Enter custom username: " custom_user
        echo "$custom_user"
    else
        echo "$selected"
    fi
}

# --- INSTANCE SELECTION ---
if [[ -z "$instance_id" ]]; then
    echo "Usage: aws-ssm-key-importer <instance-id> <username>"
    instance_id="$(select_instance_id)"

    if [[ -z "$instance_id" ]]; then
        echo "No instance selected. Exiting."
        exit 1
    fi
fi

# --- USERNAME SELECTION ---
if [[ -z "$username" ]]; then
    username="$(select_username)"
fi

# --- MAIN LOGIC ---
id_ed25519_pub=$(cat ~/.ssh/id_ed25519.pub)
ssm_command="echo '$id_ed25519_pub' >> /home/$username/.ssh/authorized_keys"

echo "Injecting key using: $ssm_command"

command_id=$(aws ssm send-command \
    --instance-ids "$instance_id" \
    --document-name "AWS-RunShellScript" \
    --parameters "commands=[\"${ssm_command}\"]" \
    --output json \
    --query "Command.CommandId")

echo "Command sent: $command_id"

raw_command_id=${command_id//\"/}

aws ssm wait command-executed \
    --instance-id "$instance_id" \
    --command-id "$raw_command_id"

echo "aws-ssm-key-importer $instance_id $username"
echo "Public key added."
