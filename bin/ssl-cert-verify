#!/usr/bin/env bash
set -u

# =========================
# Colors
# =========================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# =========================
# Usage
# =========================
usage() {
  echo "Usage:"
  echo "  $0 <private_key.pem> <certificate.pem> [fullchain.pem]"
  exit 1
}

[[ $# -lt 2 ]] && usage

KEY_FILE="$1"
CERT_FILE="$2"
FULLCHAIN_FILE="${3:-}"

# =========================
# Counters
# =========================
TOTAL=0
PASSED=0
FAILED=0

# =========================
# Helpers
# =========================
print_info() {
  sed 's/^/    /'
}

run_check() {
  local name="$1"
  local cmd="$2"

  TOTAL=$((TOTAL + 1))
  echo -e "${YELLOW}==> $name${NC}"

  OUTPUT="$(eval "$cmd" 2>&1)"
  STATUS=$?

  if [[ -n "$OUTPUT" ]]; then
    echo -e "${BLUE}Discovered:${NC}"
    echo "$OUTPUT" | print_info
  fi

  if [[ $STATUS -eq 0 ]]; then
    echo -e "${GREEN}Result: OK${NC}"
    PASSED=$((PASSED + 1))
  else
    echo -e "${RED}Result: FAILED${NC}"
    FAILED=$((FAILED + 1))
  fi

  echo
}

# =========================
# Checks
# =========================

run_check "Key matches certificate" '
  key_md5=$(openssl rsa -noout -modulus -in "'"$KEY_FILE"'" | openssl md5)
  cert_md5=$(openssl x509 -noout -modulus -in "'"$CERT_FILE"'" | openssl md5)

  echo "Private key modulus MD5 : $key_md5"
  echo "Certificate modulus MD5 : $cert_md5"

  [[ "$key_md5" == "$cert_md5" ]]
'

run_check "Certificate validity dates" '
  openssl x509 -in "'"$CERT_FILE"'" -noout -dates
'

run_check "Certificate subject & issuer" '
  openssl x509 -in "'"$CERT_FILE"'" -noout -subject -issuer
'

run_check "Certificate details (text)" '
  openssl x509 -in "'"$CERT_FILE"'" -text -noout
'

if [[ -n "$FULLCHAIN_FILE" ]]; then
  run_check "Fullchain contains entire chain" '
    openssl crl2pkcs7 -nocrl -certfile "'"$FULLCHAIN_FILE"'" \
      | openssl pkcs7 -print_certs -noout
  '

  run_check "Certificate trust validation" '
    openssl verify -CAfile "'"$FULLCHAIN_FILE"'" "'"$CERT_FILE"'"
  '
else
  echo -e "${YELLOW}==> Skipping fullchain-related checks (no fullchain provided)${NC}\n"
fi

run_check "Domains (SAN DNS entries)" '
  openssl x509 -in "'"$CERT_FILE"'" -noout -text \
    | grep "DNS:" \
    | sed -e "s/ //g" -e "s/DNS://g" -e "s/,/\n/g"
'

run_check "Subject Alternative Names section" '
  openssl x509 -in "'"$CERT_FILE"'" -noout -text \
    | grep -A1 "Subject Alternative Name"
'

# =========================
# Summary
# =========================
echo "========================="
echo "Summary"
echo "========================="
echo "Total checks : $TOTAL"
echo -e "${GREEN}Passed       : $PASSED${NC}"
echo -e "${RED}Failed       : $FAILED${NC}"

if [[ $FAILED -eq 0 ]]; then
  echo -e "${GREEN}ALL CHECKS PASSED ✔${NC}"
  exit 0
else
  echo -e "${RED}SOME CHECKS FAILED ✘${NC}"
  exit 1
fi
