#!/usr/bin/env bash
set -Eeuo pipefail

# git-wt: fast switching between git worktrees

# -------------------------
# Dependency checks
# -------------------------
require_cmd() {
    command -v "$1" >/dev/null 2>&1 || {
        echo "Error: required command '$1' not found in PATH" >&2
        exit 1
    }
}

require_cmd git

# -------------------------
# Helpers
# -------------------------
get_main_worktree() {
    git worktree list --porcelain \
        | awk '/^worktree / {print $2; exit}'
}

die() {
    echo "Error: $*" >&2
    exit 1
}

is_git_repo() {
    git rev-parse --is-inside-work-tree >/dev/null 2>&1
}

list_worktrees() {
    git worktree list
}

goto_main_worktree() {
    local main
    main=$(get_main_worktree)

    [[ -n "$main" ]] || die "Could not determine main worktree"

    echo "Changing to main worktree: $main"
    cd "$main"
    exec "$SHELL"
}

select_interactive() {
    require_cmd fzf

    git worktree list --porcelain |
        awk '
            /^worktree / { wt=$2 }
            /^branch / {
                sub("refs/heads/", "", $2)
                print wt " [" $2 "]"
            }
        ' |
        fzf --height=10% --no-multi --exit-0 |
        awk '{print $1}'
}

select_by_name() {
    local query="$1"
    git worktree list --porcelain |
        awk -v q="$query" '
            /^worktree / {
                wt=$2
                if (wt ~ q) {
                    print wt
                    exit
                }
            }
        '
}

select_secondary_worktree() {
    require_cmd fzf

    local main
    main=$(get_main_worktree)

    git worktree list --porcelain |
        awk -v main="$main" '
            /^worktree / { wt=$2 }
            /^branch / {
                sub("refs/heads/", "", $2)
                if (wt != main) {
                    print wt " [" $2 "]"
                }
            }
        ' |
        fzf --height=10% --no-multi --exit-0 --prompt="sync out-of-git files from main worktree to: " |
        awk '{print $1}'
}

sync_worktree() {
    local secondary="$1"
    local main

    main=$(get_main_worktree)
    [[ -n "$main" ]] || die "Could not determine main worktree"

    if [[ -z "$secondary" ]]; then
        secondary=$(select_secondary_worktree)
        [[ -n "$secondary" ]] || die "No secondary worktree selected"
    fi

    [[ -d "$secondary" ]] || die "Secondary worktree directory does not exist: $secondary"

    echo "Syncing untracked files from main worktree ($main) to secondary worktree ($secondary)"
    git ls-files -o -i --exclude-standard -z | rsync -a --files-from=- --from0 "$main" "$secondary"
    echo "Sync complete"
}

change_worktree() {
    local dir="$1"
    [[ -n "$dir" ]] || exit 0

    echo "Changing to worktree: $dir"
    cd "$dir"
    exec "$SHELL"
}

usage() {
    cat <<EOF
git-wt â€” fast git worktree switching

Usage:
  git-wt <name>    Switch to the first worktree matching <name>
  git-wt -i        Interactively select a worktree using fzf
  git-wt list      List all worktrees
  git-wt sync <path> Sync untracked files from main worktree to secondary worktree
  git-wt -         Go to main worktree
  git-wt help      Show this help
EOF
}

# -------------------------
# Main
# -------------------------
is_git_repo || die "Not inside a git repository"

arg="${1:-}"

case "$arg" in
    list)
        list_worktrees
        ;;
    -)
        goto_main_worktree
        ;;
    -i)
        dir=$(select_interactive)
        change_worktree "$dir"
        ;;
    sync)
        sync_worktree "${2:-}"
        ;;
    help|"")
        usage
        ;;
    *)
        dir=$(select_by_name "$arg")
        change_worktree "$dir"
        ;;
esac
